<!doctype html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DATABASE HMI MIMIKA - PRO</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: 'Inter', sans-serif; }
.hidden { display: none; }
.tabBtn {
  padding: 10px 20px;
  border-radius: 999px;
  background: #e5e7eb;
  cursor: pointer;
  transition: all 0.3s;
}
.tabBtn.active { background:#166534; color:white; }
.tabBtn:hover { transform: scale(1.05); }
.table-container { overflow-x:auto; }
table { border-collapse: collapse; width:100%; }
th, td { padding: 8px; border: 1px solid #ddd; }
th { background-color:#166534; color:white; cursor:pointer; }
tr:hover { background-color:#f1f1f1; }
.card {
  background: #fefefe; 
  padding:15px; 
  border-radius:15px; 
  box-shadow:0 3px 10px rgba(0,0,0,0.1); 
  margin-bottom:15px; 
  transition:0.3s;
}
.card:hover { transform: scale(1.02); }
</style>
</head>

<body class="bg-slate-100 min-h-screen p-4">

<!-- ================= LOGIN ================= -->
<div id="loginBox" class="max-w-md mx-auto bg-white p-6 rounded-xl shadow mt-20">
  <h2 class="text-2xl font-bold mb-4 text-center text-green-800">Login Database HMI Mimika</h2>
  <input id="username" placeholder="Username" class="border p-2 w-full mb-3 rounded">
  <input id="password" type="password" placeholder="Password" class="border p-2 w-full mb-4 rounded">
  <button onclick="login()" class="bg-green-700 text-white w-full py-2 rounded hover:bg-green-800 transition">Masuk</button>
  <p id="loginErr" class="text-red-600 mt-2 hidden text-center">Username / Password salah</p>
</div>

<!-- ================= APP ================= -->
<div id="app" class="hidden max-w-7xl mx-auto">

<header class="bg-gradient-to-r from-green-800 to-yellow-500 text-white text-center p-5 rounded-3xl shadow mb-6">
  <h1 class="text-3xl font-bold">DATABASE HMI MIMIKA - PRO</h1>
  <p id="roleText" class="mt-1 text-sm"></p>
  <button onclick="logout()" class="mt-3 bg-white text-green-800 px-4 py-1 rounded hover:bg-green-100 transition">Logout</button>
</header>

<div class="flex gap-3 mb-6 justify-center flex-wrap">
  <button class="tabBtn active" onclick="showTab('profil',this)">Profil</button>
  <button class="tabBtn" onclick="showTab('info',this)">Infografis</button>
  <button class="tabBtn" onclick="showTab('tambah',this)">Tambah Anggota</button>
</div>

<!-- PROFIL -->
<div id="profil" class="tabPage bg-white p-5 rounded-xl shadow">
  <div class="flex flex-wrap gap-3 justify-between mb-3">
    <input id="search" oninput="render()" placeholder="Cari nama / NIK / Komisariat" class="border p-2 rounded w-full md:w-1/2">
    <button onclick="downloadCSV()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Download CSV</button>
  </div>
  <div id="tableView" class="table-container max-h-[70vh] overflow-auto"></div>
</div>

<!-- INFOGRAFIS -->
<div id="info" class="tabPage hidden bg-white p-5 rounded-xl shadow">
  <h2 class="font-bold mb-2">Jumlah Anggota per Komisariat</h2>
  <canvas id="chart1"></canvas>

  <h2 class="font-bold mt-8 mb-2">Jumlah Anggota per Perguruan Tinggi</h2>
  <canvas id="chart2"></canvas>
</div>

<!-- TAMBAH -->
<div id="tambah" class="tabPage hidden bg-white p-5 rounded-xl shadow">
  <iframe src="https://tally.so/embed/BzxN1Q?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1"
  class="w-full min-h-[650px] border-0"></iframe>
</div>

<footer class="text-center mt-8 text-gray-500">IT Nesacip 2025</footer>
</div>

<script>
/* ================= USER LOGIN ================= */
const USERS = {
  ekonomi:{pass:"eko123",kom:"Komisariat Ekonomi"},
  insan:{pass:"insan123",kom:"Komisariat Insan Cita"},
  lafran:{pass:"lafran123",kom:"Komisariat Lafran Pane"},
  cabang:{pass:"admin123",kom:"ALL"}
};

let role="", rows=[], headers=[], chartA, chartB;

/* ================= LOGIN ================= */
function login(){
  const u = document.getElementById("username").value.trim().toLowerCase();
  const p = document.getElementById("password").value.trim();

  if(USERS[u] && USERS[u].pass === p){
    role = USERS[u].kom;
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("roleText").innerText = "Akses: " + role;
    loadData();
  } else {
    document.getElementById("loginErr").classList.remove("hidden");
  }
}

function logout(){ location.reload(); }

/* ================= SPREADSHEET ================= */
const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vRkxnLr5GK_w_WRktgY-SZZ2pjBHlDVSphEYLLSBLntg0IyQB3Z5178wjaES8-yMQV7ZcMTGym-VoZA/pub?gid=0&single=true&output=csv";

/* ================= PARSE CSV ================= */
async function loadData(){
  const response = await fetch(sheetURL);
  const text = await response.text();

  const parsed = parseCSV(text);
  headers = parsed.shift();
  rows = parsed;
  render();
  buildCharts();
}

function parseCSV(text){
  const result = [];
  const lines = text.split("\n");
  for(let line of lines){
    const row = [];
    let current="", inQuotes=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c=='"'){ inQuotes=!inQuotes; }
      else if(c==',' && !inQuotes){ row.push(current); current=""; }
      else{ current+=c; }
    }
    row.push(current);
    result.push(row);
  }
  return result;
}

/* ================= RENDER PROFIL ================= */
function filterRows(){
  let f=document.getElementById("search").value.toLowerCase();
  return rows.filter(r=>{
    let komis=r[13]; 
    if(role!=="ALL" && komis!==role) return false;
    return r.join(" ").toLowerCase().includes(f);
  });
}

function render(){
  const data = filterRows();
  const tableDiv = document.getElementById("tableView");
  tableDiv.innerHTML = "";

  data.forEach(r=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = headers.map((h,i)=>{
      if(["Submission ID","Respondent ID","Submitted At","Pass Photo"].includes(h)) return "";
      return `<p><strong>${h}:</strong> ${r[i] || "-"}</p>`;
    }).join("");
    tableDiv.appendChild(card);
  });
}

/* ================= TABS ================= */
function showTab(id,btn){
  document.querySelectorAll(".tabPage").forEach(x=>x.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

/* ================= DOWNLOAD CSV ================= */
function downloadCSV(){
  const data = filterRows().map(r=>{
    return headers.map((h,i)=>["Submission ID","Respondent ID","Submitted At","Pass Photo"].includes(h)?"":r[i]);
  });
  const csv = [headers.filter(h=>!["Submission ID","Respondent ID","Submitted At","Pass Photo"].includes(h)).join(","), ...data.map(r=>r.join(","))].join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="data_"+role+".csv";
  a.click();
}

/* ================= CHART ================= */
function buildCharts(){
  let komis={}, kampus={};
  rows.forEach(r=>{
    komis[r[13]]=(komis[r[13]]||0)+1;
    kampus[r[12]]=(kampus[r[12]]||0)+1;
  });

  if(chartA) chartA.destroy();
  if(chartB) chartB.destroy();

  chartA=new Chart(document.getElementById("chart1"),{
    type:"bar",
    data:{labels:Object.keys(komis),datasets:[{data:Object.values(komis)}]},
    options:{indexAxis:"y",plugins:{legend:{display:false}}}
  });

  chartB=new Chart(document.getElementById("chart2"),{
    type:"bar",
    data:{labels:Object.keys(kampus),datasets:[{data:Object.values(kampus)}]},
    options:{indexAxis:"y",plugins:{legend:{display:false}}}
  });
}

</script>
</body>
</html>
