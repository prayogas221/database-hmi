<!doctype html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DATABASE HMI MIMIKA</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.hidden{display:none;}
.tabBtn{padding:8px 16px;border-radius:999px;background:#e5e7eb;cursor:pointer;transition:all .3s;}
.tabBtn.active{background:#166534;color:white;}
.profile-card{
  border-radius:15px;
  background:#f7f7f7;
  padding:15px;
  margin-bottom:10px;
  box-shadow:0 4px 6px rgba(0,0,0,0.1);
}
input, button{transition:all .2s;}
button:hover{opacity:.9;}
</style>
</head>

<body class="bg-slate-100 min-h-screen p-4 font-sans">

<!-- ================= LOGIN ================= -->
<div id="loginBox" class="max-w-md mx-auto bg-white p-6 rounded-xl shadow mt-20 border-l-8 border-green-700">
  <h2 class="text-2xl font-bold mb-4 text-center text-green-800">Login Database HMI Mimika</h2>
  <input id="username" placeholder="Username" class="border p-2 w-full mb-3 rounded focus:ring-2 focus:ring-green-500">
  <input id="password" type="password" placeholder="Password" class="border p-2 w-full mb-4 rounded focus:ring-2 focus:ring-green-500">
  <button onclick="login()" class="bg-green-700 text-white w-full py-2 rounded font-semibold">Masuk</button>
  <p id="loginErr" class="text-red-600 mt-2 hidden text-center">Username / Password salah</p>
</div>

<!-- ================= APP ================= -->
<div id="app" class="hidden max-w-7xl mx-auto">

<header class="bg-gradient-to-r from-green-800 to-yellow-500 text-white text-center p-5 rounded-3xl shadow mb-6">
  <h1 class="text-3xl font-bold">DATABASE HMI MIMIKA</h1>
  <p id="roleText" class="mt-1 text-sm"></p>
  <button onclick="logout()" class="mt-3 bg-white text-green-800 px-4 py-1 rounded font-semibold">Logout</button>
</header>

<div class="flex gap-3 mb-6 justify-center flex-wrap">
  <button class="tabBtn active" onclick="showTab('profil',this)">Profil</button>
  <button class="tabBtn" onclick="showTab('info',this)">Infografis</button>
  <button class="tabBtn" onclick="showTab('tambah',this)">Tambah Anggota</button>
</div>

<!-- PROFIL -->
<div id="profil" class="tabPage bg-white p-5 rounded-xl shadow">
  <div class="flex flex-wrap gap-3 justify-between mb-3">
    <input id="search" oninput="render()" placeholder="Cari nama / NIK" class="border p-2 rounded w-full md:w-1/2 focus:ring-2 focus:ring-green-500">
    <button onclick="downloadCSV()" class="bg-blue-600 text-white px-4 py-2 rounded font-semibold">Download CSV</button>
  </div>
  <div id="profileContainer" class="overflow-auto max-h-[70vh]"></div>
</div>

<!-- INFOGRAFIS -->
<div id="info" class="tabPage hidden bg-white p-5 rounded-xl shadow">
  <h2 class="font-bold mb-2">Jumlah Anggota per Komisariat</h2>
  <canvas id="chart1"></canvas>

  <h2 class="font-bold mt-8 mb-2">Jumlah Anggota per Perguruan Tinggi</h2>
  <canvas id="chart2"></canvas>
</div>

<!-- TAMBAH -->
<div id="tambah" class="tabPage hidden bg-white p-5 rounded-xl shadow">
  <iframe src="https://tally.so/embed/BzxN1Q?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1"
  class="w-full min-h-[650px] border-0"></iframe>
</div>

<footer class="text-center mt-8 text-gray-500">IT Nesacip 2025</footer>
</div>

<script>
/* ================= USER LOGIN ================= */
const USERS = {
  ekonomi:{pass:"eko123",kom:"Komisariat Ekonomi"},
  insan:{pass:"insan123",kom:"Komisariat Insan Cita"},
  lafran:{pass:"lafran123",kom:"Komisariat Lafran Pane"},
  cabang:{pass:"admin123",kom:"ALL"}
};

let role="", rows=[], headers=[];
let chartA, chartB;

/* ================= LOGIN ================= */
function login(){
  const u = document.getElementById("username").value.trim().toLowerCase();
  const p = document.getElementById("password").value.trim();

  if(USERS[u] && USERS[u].pass === p){
    role = USERS[u].kom;
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("roleText").innerText = "Akses: " + role;
    loadData();
  } else {
    document.getElementById("loginErr").classList.remove("hidden");
  }
}

function logout(){
  location.reload();
}

/* ================= SPREADSHEET ================= */
const sheetURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vRkxnLr5GK_w_WRktgY-SZZ2pjBHlDVSphEYLLSBLntg0IyQB3Z5178wjaES8-yMQV7ZcMTGym-VoZA/pub?gid=0&single=true&output=csv";

/* ================= LOAD DATA ================= */
async function loadData(){
  const response = await fetch(sheetURL);
  const text = await response.text();
  const parsed = parseCSV(text);
  headers = parsed.shift();
  rows = parsed;
  render();
  buildCharts();
}

/* ================= PARSE CSV ================= */
function parseCSV(text){
  const rows = [];
  const lines = text.split("\n");
  for(let line of lines){
    const result = [];
    let current = '', insideQuotes = false;
    for(let i=0;i<line.length;i++){
      const char = line[i];
      if(char === '"') insideQuotes = !insideQuotes;
      else if(char === ',' && !insideQuotes){ result.push(current); current=''; }
      else current += char;
    }
    result.push(current);
    rows.push(result);
  }
  return rows;
}

/* ================= HIDDEN COLUMNS ================= */
function isHiddenColumn(header){
  const h = header.toLowerCase().trim();
  return /submission|respondent|submitted|pass|photo|passport/.test(h);
}

/* ================= FILTER ================= */
function filterRows(){
  let f = document.getElementById("search").value.toLowerCase();
  return rows.filter(r=>{
    const komis = r[headers.findIndex(h=>h.toLowerCase().includes("komisariat"))];
    if(role !== "ALL" && komis !== role) return false;
    return r.join(" ").toLowerCase().includes(f);
  });
}

/* ================= RENDER PROFIL ================= */
function render(){
  const container = document.getElementById("profileContainer");
  const visibleIndexes = headers.map((h,i)=>isHiddenColumn(h)?null:i).filter(i=>i!==null);
  const filtered = filterRows();

  container.innerHTML = filtered.map(r=>{
    return `<div class="profile-card">
      ${visibleIndexes.map(i=>`<p><strong>${headers[i]}:</strong> ${r[i]}</p>`).join("")}
    </div>`;
  }).join("");
}

/* ================= DOWNLOAD CSV ================= */
function downloadCSV(){
  const visibleIndexes = headers.map((h,i)=>isHiddenColumn(h)?null:i).filter(i=>i!==null);
  const filteredHeaders = headers.filter((h,i)=>visibleIndexes.includes(i));
  const filteredRows = filterRows().map(r=>visibleIndexes.map(i=>r[i]));
  const csv=[filteredHeaders.join(","), ...filteredRows.map(r=>r.join(","))].join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "data_"+role+".csv";
  a.click();
}

/* ================= TABS ================= */
function showTab(id,btn){
  document.querySelectorAll(".tabPage").forEach(x=>x.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

/* ================= CHART ================= */
function buildCharts(){
  const komis={}, kampus={};
  rows.forEach(r=>{
    const komisKey = r[headers.findIndex(h=>h.toLowerCase().includes("komisariat"))];
    const kampusKey = r[headers.findIndex(h=>h.toLowerCase().includes("perguruan"))];
    if(komisKey) komis[komisKey]=(komis[komisKey]||0)+1;
    if(kampusKey) kampus[kampusKey]=(kampus[kampusKey]||0)+1;
  });

  if(chartA) chartA.destroy();
  if(chartB) chartB.destroy();

  chartA = new Chart(document.getElementById("chart1"),{
    type:"bar",
    data:{labels:Object.keys(komis), datasets:[{data:Object.values(komis)}]},
    options:{indexAxis:"y", plugins:{legend:{display:false}}}
  });

  chartB = new Chart(document.getElementById("chart2"),{
    type:"bar",
    data:{labels:Object.keys(kampus), datasets:[{data:Object.values(kampus)}]},
    options:{indexAxis:"y", plugins:{legend:{display:false}}}
  });
}
</script>
</body>
</html>
