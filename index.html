<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Database HMI Cabang Mimika</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f9;
  margin:20px;
}
h2{ text-align:center; }

table{
  width:100%;
  border-collapse: collapse;
  margin-top:20px;
}
th, td{
  border:1px solid #ddd;
  padding:8px;
  font-size:14px;
}
th{
  background:#0f3d2e;
  color:white;
}
img{
  width:70px;
  height:90px;
  object-fit:cover;
  border-radius:6px;
}
button{
  padding:6px 12px;
  background:#0f3d2e;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
button:hover{
  background:#145c44;
}
</style>
</head>

<body>

<h2>Database Anggota HMI Cabang Mimika</h2>

<table id="dataTable">
<thead>
<tr>
<th>No</th>
<th>Nama</th>
<th>Komisariat</th>
<th>Jabatan</th>
<th>Posisi Jabatan</th>
<th>Foto</th>
<th>Aksi</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>

const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRkxnLr5GK_w_WRktgY-SZZ2pjBHlDVSphEYLLSBLntg0IyQB3Z5178wjaES8-yMQV7ZcMTGym-VoZA/pub?gid=0&single=true&output=csv";

function cleanURL(text){
  if(!text) return "";
  const match = text.match(/https?:\/\/[^\s]+/);
  return match ? match[0] : "";
}

async function convertToBase64(url){
  try{
    const response = await fetch(url);
    const blob = await response.blob();
    return await new Promise((resolve)=>{
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  }catch(err){
    return "";
  }
}

Papa.parse(sheetURL,{
  download:true,
  header:true,
  complete: async function(results){

    const tbody = document.querySelector("#dataTable tbody");

    for(let i=0;i<results.data.length;i++){

      const row = results.data[i];

      if(!row.Nama) continue;

      const tr = document.createElement("tr");

      const fotoURL = cleanURL(row.Foto);
      const fotoBase64 = await convertToBase64(fotoURL);

      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${row.Nama || ""}</td>
        <td>${row.Komisariat || ""}</td>
        <td>${row["Jabatan di HMI"] || ""}</td>
        <td>${row["Posisi Jabatan"] || ""}</td>
        <td>${fotoBase64 ? `<img src="${fotoBase64}">` : "Tidak ada foto"}</td>
        <td>
          <button onclick="cetakRow(this)">Cetak</button>
        </td>
      `;

      tbody.appendChild(tr);
    }
  }
});

function cetakRow(btn){
  const row = btn.closest("tr").cloneNode(true);
  row.querySelector("button").remove();

  const container = document.createElement("div");
  container.appendChild(row);

  html2pdf().set({
    margin:0.5,
    filename:"Data_Anggota_HMI.pdf",
    html2canvas:{scale:2,useCORS:true},
    jsPDF:{unit:'in',format:'a4',orientation:'portrait'}
  }).from(container).save();
}

</script>

</body>
</html>
